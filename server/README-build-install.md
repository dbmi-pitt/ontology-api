# HubMAP OpenAPI Server

## Overview
This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project. By using the
[OpenAPI-Spec](https://openapis.org) located in the top level directory as [ontology-openapi3.yml](../ontology-openapi3.yml).
The server is created using the [build-server.sh](../build-server.sh) shell script.

A [Postman](https://www.postman.com/) collection [Ontology.postman_collection.json](./Ontology.postman_collection.json) for accessing/testing the [RestFUL](https://en.wikipedia.org/wiki/Representational_state_transfer) endpoints available.
To use it you will need to setup the following Postman Environments:
* ***localhost***: defining **ontology_url** as [http://localhost:8080](http://localhost:8080)
* ***dev***: defining **ontology_url** as [https://ontology-api.dev.hubmapconsortium.org](https://ontology-api.dev.hubmapconsortium.org)

The server uses the [Connexion](https://github.com/zalando/connexion) library on top of [Flask](https://flask.palletsprojects.com/en/2.0.x/).

## Design
The OpenAPI Generator will create the server in **openapi_server**.
All endpoints and Flask related calls are kept in **controllers/default_controller.py**.
Each controller makes one call to a method of the same name found in **managers/neo4j_manager.py**.
In this manner the OpenAPI generated Flask code is separated from the business logic located in the manager.

Adding a new endpoint requires updating the **ontology-openapi3.yml**, running **build-server.sh**, creating an additional business logic method in **neo4j_manager.py**, and adding a call to it in the generated **default_controller.py**.
Note that generating the new server will remove all calls from the controller to the manager, so you should use git compare to copy them back from the previous edition.

## Running Locally
Executing the following script will start the server locally accessing the Neo4J database running in dev.

```
./run_server_on_localhost.py
```

The server will be available at the URL
```
http://localhost:8080/
```

## Rebuilding the Docker container

To get the latest version of the server on the server execute the following:

```bash
# Access the server, switch accounts and go to the server directory
$ ssh -i ~/.ssh/id_rsa_e2c.pem cpk36@ingest.dev.hubmapconsortium.org
$ sudo /bin/su - centos
$ cd hubmap/ontology-api
# Get the most recent version of the code
$ git pull
```

At this point you can shut down the server, remove the old image, rebuild it, and restart it.
```bash
# Shut down the server
$ docker images
REPOSITORY                  TAG                 IMAGE ID            CREATED             SIZE
ontology-api_ontology-api   latest              24b1f748f10f        31 minutes ago      77.6MB
...
$ docker-compose -f docker-compose.deployment.api.yml down

# Remove the old image
$ docker rmi -f 24b1f748f10f

# Rebuild the image
$ docker-compose -f docker-compose.deployment.api.yml build --no-cache

# Startup the container
$ docker-compose -f docker-compose.deployment.api.yml up -d

# Verify that it is running
$ docker ps
CONTAINER ID        IMAGE                        COMMAND                  CREATED             STATUS                 PORTS           NAMES
95ff4678fab4        ontology-api_ontology-api    "/usr/local/bin/entrâ€¦"   8 seconds ago       Up 8 seconds           5000/tcp        ontology-api
```

Disconnect from the server
```bash
$ exit
logout
[cpk36@ip-172-31-91-142 ~]$ exit
logout
Connection to ingest.dev.hubmapconsortium.org closed.
```

## Setting permissions on the endpoints

The [hubmapconsortium/gateway](https://github.com/hubmapconsortium/gateway/) defines the protection on endpoints
for: dev, test, start, and prod. Currently there is no protection set on the endpoints and so they should be marked as follows:
```bash
{
  "ontology-api.dev.hubmapconsortium.org": [
   {
      "method": "GET",
      "endpoint": "/fullCapacityParameterizedTerm/<*>",
      "auth": false
    }
  ]
}
```

